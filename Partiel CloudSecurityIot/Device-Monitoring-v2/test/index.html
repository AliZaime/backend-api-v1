<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>IoT Multi-Device Dashboard</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body {
        font-family: "Inter", sans-serif;
        background: #0f172a;
        color: #f8fafc;
        padding: 20px;
        margin: 0;
      }
      .container {
        max-width: 1200px;
        margin: auto;
      }
      h1 {
        color: #38bdf8;
        text-align: center;
        font-weight: 300;
        letter-spacing: 2px;
        margin-bottom: 30px;
      }

      /* Grid Layout for Charts */
      #charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(450px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .chart-card {
        background: #1e293b;
        padding: 20px;
        border-radius: 12px;
        border: 1px solid #334155;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      }

      .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        border-bottom: 1px solid #334155;
        padding-bottom: 10px;
      }

      .device-name {
        color: #38bdf8;
        font-weight: 600;
        font-size: 16px;
      }
      .live-value {
        font-family: "Fira Code", monospace;
        color: #4ade80;
        font-weight: bold;
      }

      #log-container {
        margin-top: 30px;
      }
      #log {
        font-family: "Fira Code", monospace;
        background: #000;
        color: #94a3b8;
        padding: 15px;
        height: 150px;
        overflow-y: auto;
        border-radius: 8px;
        font-size: 12px;
        border: 1px solid #334155;
      }

      .status-dot {
        height: 10px;
        width: 10px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 5px;
      }
      .connected {
        background-color: #4ade80;
        box-shadow: 0 0 8px #4ade80;
      }
      .disconnected {
        background-color: #ef4444;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>
        <span id="status-dot" class="status-dot disconnected"></span>
        IOT LIVE NETWORK
      </h1>

      <div id="charts-grid">
        <!-- Les graphiques seront injectés ici dynamiquement -->
      </div>

      <div id="log-container">
        <h3>Flux de données brut</h3>
        <div id="log">Connexion au réseau IoT...</div>
      </div>
    </div>

    <script>
      const socket = io({ transports: ["websocket"] });
      const grid = document.getElementById("charts-grid");
      const logDiv = document.getElementById("log");
      const statusDot = document.getElementById("status-dot");

      const deviceCharts = {}; // Stocke les instances de graphiques par device_id

      function createDeviceChart(deviceId, name, type, unit) {
        // Création de la structure HTML
        const card = document.createElement("div");
        card.className = "chart-card";
        card.id = `card-${deviceId}`;
        card.innerHTML = `
                <div class="chart-header">
                    <div>
                        <span class="device-name">${name || deviceId}</span>
                        <div style="font-size: 10px; color: #64748b;">${type} • ${deviceId}</div>
                    </div>
                    <div id="value-${deviceId}" class="live-value">--</div>
                </div>
                <div style="height: 180px; position: relative;">
                    <canvas id="canvas-${deviceId}"></canvas>
                </div>
            `;
        grid.appendChild(card);

        // Création du graphique Chart.js
        const ctx = document
          .getElementById(`canvas-${deviceId}`)
          .getContext("2d");

        // Configuration des couleurs représentatives
        const colors = {
          temperature: "#ef4444", // Rouge
          humidity: "#3b82f6", // Bleu
          light: "#eab308", // Jaune/Or
          pressure: "#a855f7", // Violet
          cpu: "#38bdf8", // Sky Blue
          ram: "#10b981", // Emerald
        };

        const datasets = [];
        if (type === "system") {
          datasets.push({
            label: "CPU (%)",
            data: [],
            borderColor: colors.cpu,
            backgroundColor: colors.cpu + "22",
            borderWidth: 2,
            fill: true,
            tension: 0.4, // Un peu plus de courbure pour le look pro
            pointRadius: 0,
          });
          datasets.push({
            label: "RAM (%)",
            data: [],
            borderColor: colors.ram,
            backgroundColor: colors.ram + "22",
            borderWidth: 2,
            fill: true,
            tension: 0.4,
            pointRadius: 0,
          });
        } else {
          const color =
            colors[type] ||
            "#" +
              Math.floor(Math.random() * 16777215)
                .toString(16)
                .padStart(6, "0");
          datasets.push({
            label: type,
            data: [],
            borderColor: color,
            backgroundColor: color + "22",
            borderWidth: 2,
            fill: true,
            tension: 0.4,
            pointRadius: 0,
          });
        }

        const chart = new Chart(ctx, {
          type: "line",
          data: {
            labels: [],
            datasets: datasets,
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            // Animation "Streaming" ultra-fluide : linéaire et calée sur 1s
            animation: {
              duration: 1000,
              easing: "linear",
            },
            plugins: {
              legend: {
                display: type === "system",
                labels: { color: "#94a3b8", boxWidth: 10, font: { size: 10 } },
                position: "bottom",
              },
            },
            scales: {
              x: { display: false },
              y: {
                ticks: {
                  color: "#64748b",
                  callback: function (value) {
                    return value + (unit || "");
                  },
                },
                grid: { color: "#334155" },
                beginAtZero: true,
                max:
                  type === "system" || type === "light" || type === "humidity"
                    ? 100
                    : undefined,
              },
            },
          },
        });

        return { chart, valueEl: document.getElementById(`value-${deviceId}`) };
      }

      socket.on("connect", () => {
        statusDot.className = "status-dot connected";
        addLog("✓ Système de monitoring en ligne");
      });

      socket.on("disconnect", () => {
        statusDot.className = "status-dot disconnected";
        addLog("✗ Déconnecté du serveur");
      });

      socket.on("metrics_live", (data) => {
        const deviceId = data.device_id;

        // Si le graphique pour ce device n'existe pas, on le crée
        if (!deviceCharts[deviceId]) {
          deviceCharts[deviceId] = createDeviceChart(
            deviceId,
            data.name,
            data.type,
            data.unit,
          );
        }

        const { chart, valueEl } = deviceCharts[deviceId];

        // Traitement de l'affichage texte
        let displayValue = "";
        const timeLabel = new Date().toLocaleTimeString();
        chart.data.labels.push(timeLabel);

        if (data.type === "system" && typeof data.value === "object") {
          const cpu = data.value.cpu_percent || 0;
          const ram = data.value.ram_percent || 0;
          displayValue = `${cpu}% CPU | ${ram}% RAM`;

          // On met à jour les deux datasets
          chart.data.datasets[0].data.push(cpu);
          chart.data.datasets[1].data.push(ram);
        } else {
          displayValue = `${data.value}${data.unit || ""}`;
          chart.data.datasets[0].data.push(data.value);
        }

        // Mise à jour de l'UI
        valueEl.innerText = displayValue;
        addLog(`${data.device_id}: ${displayValue}`);

        // Garder les 50 derniers points par graphique pour tous les datasets
        if (chart.data.labels.length > 50) {
          chart.data.labels.shift();
          chart.data.datasets.forEach((ds) => ds.data.shift());
        }
        chart.update();
      });

      function addLog(msg) {
        const div = document.createElement("div");
        div.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
        logDiv.prepend(div);
        if (logDiv.children.length > 30) logDiv.lastChild.remove();
      }
    </script>
  </body>
</html>
